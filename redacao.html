<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>MelhorENEM+ - Correção de Redação</title>
    <link rel="stylesheet" href="style.css"> 
    <link rel="stylesheet" href="redacao.css"> 
</head>
<body>
    <main>
        <h1>MelhorENEM+</h1>
        <p>Utilizaremos a API do Google Gemini para corrigir sua redação com base nas 5 Competências do ENEM.</p>

        <h2>Escreva sua Redação para Correção Instantânea</h2>
        
        <div class="controls-and-input">
            
            <div class="top-buttons">
                <button id="btnVoltarSalvar" class="btn-secundario">← Salvar e Voltar</button>
                <button id="btnVoltarDashboard" class="btn-secundario" onclick="window.location.href='dashboard.html'">Voltar ao Dashboard</button>
            </div>

            <textarea id="redacao-input" placeholder="Seu Texto Dissertativo-Argumentativo (Mínimo de 100 caracteres)..."></textarea>
            
            <button id="btnCorrigir" class="btn-principal" onclick="corrigirRedacao()">CORRIGIR COM GEMINI IA</button>
        </div>

        <div id="correcao-resultado" style="display: none;">
            <h3>✅ Correção da Gemini IA</h3>
            <div class="notas-container">
                <p>Nota Final: <span id="nota-final">0</span></p>
                <p>C1 (Norma): <span id="c1-score">0</span></p>
                <p>C2 (Tema): <span id="c2-score">0</span></p>
                <p>C3 (Argumentos): <span id="c3-score">0</span></p>
                <p>C4 (Coesão): <span id="c4-score">0</span></p>
                <p>C5 (Intervenção): <span id="c5-score">0</span></p>
            </div>
            <h4>Feedback Detalhado:</h4>
            <p id="feedback-detalhado"></p>
        </div>
        
        <div id="status-message" style="margin-top: 20px; color: red;"></div>
    </main>

    <script>
        const BACKEND_URL = 'http://localhost:3000';
        const redacaoInput = document.getElementById('redacao-input');
        const statusMessage = document.getElementById('status-message');
        const resultadoDiv = document.getElementById('correcao-resultado');
        const temaPadrao = "Invisibilidade do trabalho de cuidado no Brasil."; 

        // Tenta carregar rascunho (Função desabilitada por enquanto)
        const params = new URLSearchParams(window.location.search);
        const rascunhoId = params.get('rascunho_id');
        
        
        // --- FUNÇÃO DE CORREÇÃO ---
        async function corrigirRedacao() {
            const redacao = redacaoInput.value;
            statusMessage.textContent = '';
            resultadoDiv.style.display = 'none';

            if (redacao.length < 50) {
                statusMessage.textContent = 'A redação precisa ter no mínimo 50 caracteres para ser corrigida.';
                return;
            }

            try {
                statusMessage.textContent = 'Corrigindo redação... Aguarde.';
                const response = await fetch(`${BACKEND_URL}/api/corrigir-redacao`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ redacao: redacao, tema: temaPadrao })
                });

                statusMessage.textContent = '';
                const data = await response.json();

                if (response.ok) {
                    // Exibir a correção
                    document.getElementById('nota-final').textContent = data.nota_final;
                    document.getElementById('c1-score').textContent = data.c1_score;
                    document.getElementById('c2-score').textContent = data.c2_score;
                    document.getElementById('c3-score').textContent = data.c3_score;
                    document.getElementById('c4-score').textContent = data.c4_score;
                    document.getElementById('c5-score').textContent = data.c5_score;
                    // O replace substitui a quebra de linha da IA por tags <br> para HTML
                    document.getElementById('feedback-detalhado').innerHTML = data.feedback_detalhado.replace(/\n/g, '<br>');
                    resultadoDiv.style.display = 'block';
                } else {
                    statusMessage.textContent = `Erro do servidor: ${data.error || 'Falha desconhecida.'}`;
                }

            } catch (error) {
                console.error('Erro na correção:', error);
                statusMessage.textContent = 'Erro: Não foi possível conectar ao servidor (porta 3000). Verifique se o Node.js está rodando.';
            }
        }

        // --- FUNÇÃO PARA SALVAR RASCUNHO (Funcionalidade NOVO/Mantida) ---
        document.getElementById('btnVoltarSalvar').addEventListener('click', salvarRascunho);

        async function salvarRascunho() {
            const redacaoTexto = redacaoInput.value;
            
            if (redacaoTexto.trim() === '') {
                alert('Não há texto para salvar como rascunho.');
                return;
            }

            try {
                const response = await fetch(`${BACKEND_URL}/api/salvar-rascunho`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ redacao: redacaoTexto })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert('Rascunho salvo com sucesso! Redirecionando...');
                    window.location.href = 'dashboard.html';
                } else {
                    alert('Falha ao salvar rascunho: ' + (result.error || 'Erro interno.'));
                }

            } catch (error) {
                console.error('Erro ao chamar a API de rascunho:', error);
                alert('Erro ao se comunicar com o servidor para salvar o rascunho.');
            }
        }
    </script>
</body>
</html>